<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>知识点详情</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; margin: 20px; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    .card { border: 1px solid #ddd; border-radius: 6px; padding: 12px; }
    .title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .meta { color: #555; margin-bottom: 12px; }
    .list { display: grid; gap: 8px; }
    .item { border: 1px solid #eee; border-radius: 6px; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    a.btn { text-decoration: none; background: #2B7CE9; color: #fff; padding: 6px 10px; border-radius: 4px; }
    .error { color: #c00; margin-top: 10px; }
  </style>
  <script>
    function qs() { return new URLSearchParams(window.location.search); }
    async function loadNode() {
      const params = qs();
      const name = params.get('name') || '';
      const classId = params.get('classId') || '1';
      const startDate = params.get('startDate') || '2025-11-26';
      const endDate = params.get('endDate') || '2025-12-02';
      const err = document.getElementById('error');
      err.textContent = '';
      try {
        const url = `/api/knowledge-graph/node/${encodeURIComponent(name)}`;
        const res = await fetch(url, { headers: { 'Class-ID': classId, 'Start-Date': startDate, 'End-Date': endDate } });
        if (!res.ok) { const t = await res.text(); throw new Error(t || String(res.status)); }
        const data = await res.json();
        renderNode(name, data);
      } catch (e) { err.textContent = '加载失败: ' + e.message; }
    }
    function renderNode(name, data) {
      document.getElementById('title').textContent = name;
      const n = data.node || {};
      document.getElementById('content').textContent = n.content || '';
      document.getElementById('meta').textContent = `总错误: ${n.total_errors || 0}，最长前置路径: ${n.longest_path || 0}`;
      const daily = n.daily_errors || {};
      const labels = Object.keys(daily).sort();
      const values = labels.map(k => daily[k] || 0);
      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: '每日错误', data: values, borderColor: '#2B7CE9', backgroundColor: 'rgba(43,124,233,0.1)', tension: 0.2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
      const list = document.getElementById('preceding');
      list.innerHTML = '';
      (data.preceding_nodes || []).forEach(p => {
        const div = document.createElement('div');
        div.className = 'item';
        const left = document.createElement('div');
        left.textContent = `${p.name}（总错 ${p.total_errors || 0}）`;
        const right = document.createElement('div');
        const params = new URLSearchParams(new URLSearchParams(window.location.search));
        params.set('name', p.name);
        const a1 = document.createElement('a');
        a1.href = `/static/node_detail.html?${params.toString()}`;
        a1.className = 'btn';
        a1.textContent = '查看详情';
        const a2 = document.createElement('a');
        a2.href = `/static/display_knowledge_graph.html?center=${encodeURIComponent(p.name)}`;
        a2.className = 'btn';
        a2.textContent = '查看结构';
        right.appendChild(a1);
        right.appendChild(a2);
        div.appendChild(left);
        div.appendChild(right);
        list.appendChild(div);
      });
    }
    window.addEventListener('DOMContentLoaded', loadNode);
  </script>
</head>
<body>
  <h1>知识点详情</h1>
  <div class="card">
    <div class="title" id="title"></div>
    <div class="meta" id="meta"></div>
    <div id="content"></div>
  </div>
  <div class="grid">
    <div class="card" style="height:360px;">
      <canvas id="chart"></canvas>
    </div>
    <div class="card">
      <div class="title">前置高频节点</div>
      <div class="list" id="preceding"></div>
    </div>
  </div>
  <div id="error" class="error"></div>
  <div style="margin-top:12px; display:flex; gap:8px;">
    <a class="btn" href="/static/breakpoints.html">返回断点榜单</a>
  </div>
</body>
</html>
